metadata:
  generated_at_utc: "2025-11-01T09:56:00Z"
  author: codex-cli
  language: "ja"
  source_summary: >
    CLI上で複数のコーディングエージェントを並列稼働させ、最終的にBossエージェントが
    出力を評価・統合できるOSSを開発する。
現在の状況:
  ステータス: "要件定義中"
  未解決事項:
    - "エージェントが利用する具体的なLLMやエンジンの選定"
    - "Bossエージェントの採点アルゴリズム・指標の詳細"
    - "フォーク後に取得した新セッションIDの記録・共有方式"
概要:
  目標: >
    同一指示を複数エージェントへ同時配信し、その成果をBossエージェントが評価・統合する
    開発支援CLIツールを提供する。
  成功指標:
    - "1コマンドでN個のエージェント環境（tmux + git worktree）を立ち上げられること。"
    - "各エージェントのログを詳細に取得し、障害箇所を追跡できること。"
    - "Bossエージェントが任意のエージェント成果物を選択・統合し、継続作業に接続できること。"
  並列起動フロー:
    - "ユーザーはメインCodexセッションに指示を送る。"
    - "Orchestratorは直近のユーザー指示を捕捉し、メインセッションを即時中断する。"
    - "保存した指示を用い、各ワークツリー用tmuxセッションで同一セッションをresumeし、自動フォーク（Esc操作送信）で独立セッションIDを得る。"
    - "独立した各セッションへ指示を再送し、並列エージェントを起動する。"
主なインターフェース:
  cli:
    目的: "指示受付・パイプライン制御・結果承認を一元化するフロントエンド。将来的にGUIへ移行できるAPI設計を前提とする。"
    機能:
      - "指示入力コマンド（例: `parallel-dev prompt \"...\"`）でメインCodexへ送信。"
      - "tmuxレイアウト管理（セッション1個 + メイン/Boss/worker*Nペイン、Nのデフォルトは3）。"
      - "ワークフロー状態遷移管理（指示受付→フォーク展開→完了検知→Boss選抜→マージ→次サイクル）。"
      - "REST/IPC化を見据えた内部APIを提供し、将来的なGUI接続を想定。"
tmuxレイアウト:
  セッション: "1つのtmuxセッションにメインCodex、Boss Codex、worker*Nの計N+2ペインを配置。"
  デフォルトN: 3
  ペイン役割:
    - "メイン: 指示を受け取る専用。"
    - "Boss: 評価・統合・マージを行う。"
    - "worker: 並列開発を担当。必要に応じて追加生成・終了が可能。"
ログ設計:
  - "tmux各ペインの履歴は`logs/<タイムスタンプ>/<role>.log`に収集する。"
  - "Codexのrollout JSONLは`logs/<タイムスタンプ>/sessions/<session_id>.jsonl`へコピー。"
  - "CLIイベントログを`logs/<タイムスタンプ>/cli.log`に出力し、開始/終了ステージ・採点結果・エラーを記録。"
  - "Boss評価結果や採点シートは`logs/<タイムスタンプ>/boss_eval.yaml`にまとめる。"
完了検知方式:
  - "各workerはタスク完了時に必ず`/done`メッセージを送信する（AGENTS.mdやプロンプトで厳守させる）。"
  - "CLIはCodexのrollout JSONLを常時監視し、`/done`を検出したworkerを完了とみなす。すべてのworkerで検出できた時点でBossフェーズへ遷移する。"
  - "一定時間内に`/done`が揃わない場合のみCLIがユーザーへ確認ダイアログ（CLI上のプロンプト）を提示し、手動で待機/中断を選択できるようにする。"
セッションID取得:
 - "フォーク後、CLIは~/.codex/sessions/YYYY/MM/DD/配下のファイルイベントを監視し、新規に生成されたrollout-*.jsonlの先頭行（SessionMeta）をパースして`id`値を取得する。"
  - "ファイル名に含まれるUUIDとSessionMeta内のIDを照合し、一致確認後にセッションIDとして採用する。"
  - "監視が失敗した場合の冗長経路として、対象ペイン上で`codex resume --last --json`を実行し、JSON出力の`conversation_id`を抽出する。"
  - "取得したIDは`logs/<タイムスタンプ>/sessions_map.yaml`にメインIDとの対応表として保存し、各worker ID → JSONLパス → git worktreeパスを紐づける。"
  - "Bossが採用したセッションをメインに昇格させる際は、このMapを用いて対象セッションのJSONL・worktree・ペインIDを逆引きし、必要に応じてメインペインで`codex resume <採用ID>`を再起動する。"
機能要件:
  - id: F-001
    内容: "CLIコマンドでタスク指示を作成し、N個のエージェントに同時ブロードキャストする。"
  - id: F-002
    内容: "各エージェントごとに独立したgit worktreeを生成・管理する。"
  - id: F-003
    内容: "tmuxセッション（またはペイン）上でエージェントを起動し、resumeで文脈を保持する。"
  - id: F-004
    内容: "エージェントごとの詳細ログを生成し、トラブルシュートを容易にする。"
  - id: F-005
    内容: "Bossエージェントが成果物を閲覧し、採点・選択・統合できるUI/コマンドを備える。"
  - id: F-006
    内容: "Bossエージェントが選択したエージェント環境を引き継ぎ、再び指示を出せるようにする。"
  - id: F-007
    内容: "メインセッションで取得したユーザー指示を自動的に保存・中断し、フォーク済み各セッションへ再送する制御機構を提供する。"
  - id: F-008
    内容: "tmuxレイアウト（メイン/Boss/worker*N）の生成・破棄・再配置をCLIから一括操作できるようにする。"
  - id: F-009
    内容: "Codex JSONLから`/done`メッセージを検出し、全worker完了時にBossフェーズへ遷移するワークフロー制御を実装する。"
  - id: F-010
    内容: "フォーク後に生成された各セッションIDを自動取得し、ログとBoss統合プロセスに関連付ける。"
成果物:
  - "CLI実装コードとテスト（TTDベース）。"
  - "セットアップ・利用方法・ログ方針を説明するドキュメント。"
  - "複数エージェント起動スクリプト、tmux制御スクリプト、Boss用統合ツール。"
留意事項:
  - "区切りのタイミングでgitコミットし、docs/experiment.yamlに活動ログを記録する。"
  - "手動で判断して要件を変更する際は、事前に依頼者の承認を得る。"
